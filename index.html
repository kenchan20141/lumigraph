<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻水．議 (基礎範文版)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;600&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
       :root {
            /* 基礎版配色：改為較溫暖的卡其色調，感覺較親切，不那麼高冷 */
            --bg-color: #FDFBF7; 
            --text-color: #4E4E4E;
            --primary-color: #5D4037; 
            --secondary-color: #8D6E63;
            --border-color: #D7CCC8;
            --accent-color: #FF7043;
            --font-serif: 'Noto Serif JP', serif;
            --font-sans: 'Zen Kaku Gothic New', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            font-weight: 300;
            overflow-x: hidden;
            background-image: url('data:image/svg+xml,%3Csvg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="none" fill-rule="evenodd"%3E%3Cg fill="%23D7CCC8" fill-opacity="0.2"%3E%3Cpath d="M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 3rem;
        }

        header {
            text-align: center;
            padding: 2rem 0 3rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 3rem;
        }

        header h1 {
            font-family: var(--font-serif);
            font-size: 2.8rem;
            font-weight: 400;
            color: var(--primary-color);
            letter-spacing: 0.2em;
        }

        header p {
            font-size: 1rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            letter-spacing: 0.1em;
        }

        main {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 4rem;
            flex-grow: 1;
        }

        .controls {
            padding-right: 2rem;
            border-right: 1px solid var(--border-color);
        }

        .control-group {
            margin-bottom: 2.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 1rem;
            font-family: var(--font-serif);
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--primary-color);
        }

        .control-group input[type="text"],
        .control-group textarea {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            background-color: transparent;
            border-radius: 4px;
            font-family: var(--font-sans);
            font-size: 1rem;
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .control-group input[type="text"]:focus,
        .control-group textarea:focus {
          outline: none;
          border-color: var(--accent-color);
          box-shadow: 0 0 5px rgba(255, 112, 67, 0.25);
        }

        .control-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .word-count-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .word-count-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--primary-color);
            width: 30px;
            height: 30px;
            font-size: 1.5rem;
            line-height: 26px;
            text-align: center;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.3s, color 0.3s;
        }

        .word-count-btn:hover {
            background-color: var(--primary-color);
            color: var(--bg-color);
        }

        #word-count-display {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-color);
            background-color: #FFFFFF;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-width: 80px;
            text-align: center;
        }

        .style-selector {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .style-selector label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .style-selector input[type="radio"] {
            display: none;
        }

        .style-selector input[type="radio"]:checked + span {
            font-weight: 500;
        }

        .style-selector label:has(input:checked) {
             background-color: var(--accent-color);
             border-color: var(--accent-color);
             color: #FFFFFF;
        }

        .generate-btn {
            width: 100%;
            padding: 1rem;
            margin-top: 1.5rem;
            font-family: var(--font-serif);
            font-size: 1.2rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .generate-btn:hover {
            background-color: #3E2723;
        }
        
        .generate-btn:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }

        .output {
            position: relative;
        }
        
        .output-toolbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        #output-word-count {
            font-size: 0.9rem;
            color: var(--secondary-color);
            font-family: var(--font-sans);
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }

        .icon-btn:hover {
            background-color: #EFEBE9;
        }

        .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--primary-color);
        }

        .icon-btn .copy-feedback {
            font-size: 0.9rem;
            font-family: var(--font-sans);
        }

        #essay-placeholder, #generated-essay {
            padding: 2rem;
            background-color: #FFFFFF;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            min-height: 60vh;
            white-space: pre-wrap;
            font-family: var(--font-serif);
            font-size: 1.1rem;
            line-height: 2.2;
            letter-spacing: 0.05em;
        }
        
        #essay-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-size: 1.5rem;
        }

        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 5px solid var(--bg-color);
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            .controls {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 2rem;
            }
            .container {
                padding: 1.5rem;
            }
        }

    </style>
</head>
<body>

    <!-- 
      ★★★ 重要修改區：議論文寫作指令 (Level 3-4 版本) ★★★ 
      這個 Prompt 被重新設計，指示 AI 寫出「一般學生」的文章。
      重點：結構工整但刻板，例子大路，詞彙平實，避免過度哲理。
    -->
    <div id="argumentative-prompt" style="display: none;"><pre>
你是一個DSE中文議論文寫作助手。請根據以下指令，生成一篇【及格至中等水平（Level 3 - Level 4）】的議論文。

[目標讀者] 基礎較弱、希望學習如何寫出結構完整、論點清晰的合格文章的學生。文章不應太深奧，要讓他們覺得「我也能寫得出來」。

[文章水平定位：Level 3 至 Level 4]
1.  **結構**：必須完整工整（引言、三個主要段落、結尾）。
2.  **內容**：論點清晰，但屬於「大路」（常見）觀點，不需要極度深刻的哲學反思。
3.  **例證**：使用**常見、著名且易於理解的例子**（如：愛迪生、貝多芬、喬布斯、日常生活例子），避免使用生僻冷門的古文典故。
4.  **語言**：通順、平實，多用標準的連接詞（如：首先、其次、再者、總括而言）。避免過多華麗的修辭或艱深的成語。
5.  **論證**：有解釋例子與論點的關係，但分析可以比較直接，不需要像 Level 5** 那樣層層遞進、反覆辯證。

[文章結構要求]
1.  **引言**：
    *   簡單解釋題目的關鍵詞。
    *   指出這個話題在生活很常見。
    *   清晰表達立場（同意/不同意/看法）。
2.  **主體段落一（論點一）**：
    *   **中心句**：用「首先」開頭，提出第一個最直接的理由。
    *   **例子**：引用一個非常著名的例子（例如名人故事）。
    *   **解釋**：簡單說明這個例子如何證明你的觀點。
3.  **主體段落二（論點二）**：
    *   **中心句**：用「其次」開頭，提出第二個理由。
    *   **例子**：可以用日常生活觀察或社會現象作為例子。
    *   **解釋**：說明這對個人或社會有什麼好處/壞處。
4.  **主體段落三（駁論/反思）**：
    *   **讓步**：用「有人可能會說...」提出一個簡單的反方觀點。
    *   **反駁**：用「然而/但是...」進行反駁，指出反方觀點的不足之處。
5.  **結尾**：
    *   **總結**：重申立場，簡單概括上述論點。
    *   **昇華**：給出一句簡單的建議或呼籲（例如：我們應該...）。

[主題]： [請在此處填入您希望探討的議論文主題]

[重要提醒]
1.  **嚴格控制字數**：約1000 - 1200字即可，太長會讓基礎學生感到壓力。
2.  **不要炫技**：不要用「鏡花水月」、「樊籠」這類太文藝的詞，用「虛幻」、「束縛」就好。
3.  **例子要親民**：如果題目是論得失，可以用「運動員比賽輸贏」或「考試失敗」做例子，比用「秦始皇」更讓基礎學生有共鳴。
4.  **格式**：只輸出文章內容，不要有標題、不要有解釋文字。
5.  **立場**：立場要鮮明，不要模稜兩可。
    </pre></div>
    
    <div class="container">
        <header>
            <h1>翻水．議</h1>
            <p>基礎範文版（Level 3-4）</p>
        </header>
        <main>
            <div class="controls">
                <div class="control-group">
                    <label for="topic-input">文章題目</label>
                    <input type="text" id="topic-input" placeholder="例如：談堅持">
                </div>
                <div class="control-group">
                    <label for="guidelines-input">創作指引</label>
                    <textarea id="guidelines-input" placeholder="在此輸入簡單的想法，例如：我想用愛迪生做例子..."></textarea>
                </div>
                <div class="control-group">
                    <label>預設字數</label>
                    <div class="word-count-control">
                        <button class="word-count-btn" id="decrease-words">-</button>
                        <span id="word-count-display">1000</span>
                        <button class="word-count-btn" id="increase-words">+</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>選擇模型</label>
                    <div class="style-selector">
                        <label>
                            <input type="radio" name="model" value="gemini" checked>
                            <span>魚木</span>
                        </label>
                        <label>
                            <input type="radio" name="model" value="gemini">
                            <span>水心</span>
                        </label>
                    </div>
                </div>
                <button class="generate-btn" id="generate-btn">生成基礎範文</button>
            </div>
            <div class="output">
                <div id="essay-placeholder">靜待靈感 ...</div>
                <div id="output-toolbar" class="output-toolbar" style="display:none;">
                    <span id="output-word-count"></span>
                    <button id="copy-btn" class="icon-btn" title="複製全文"></button>
                </div>
                <div id="generated-essay" style="display:none;"></div>
                <div id="loader" class="loader" style="display:none;"></div>
            </div>
        </main>
    </div>

    <script>
        // ===============================================================
        // === [神思通用組件] 權限攔截器 & 莫蘭迪提示窗 (含登入連結) ===
        // ===============================================================
        (function() {
            if (window.SansiInterceptorLoaded) return;
            window.SansiInterceptorLoaded = true;

            const style = document.createElement('style');
            style.textContent = `
                .sansi-limit-overlay {
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(253, 252, 248, 0.88);
                    backdrop-filter: blur(6px);
                    z-index: 9999999;
                    display: none; justify-content: center; align-items: center;
                    opacity: 0; transition: opacity 0.3s ease;
                }
                .sansi-limit-show { opacity: 1; }
                .sansi-limit-card {
                    background: #fdfcf8;
                    border: 1px solid #e0ddd7;
                    border-radius: 16px;
                    padding: 30px 25px;
                    width: 90%; max-width: 380px;
                    box-shadow: 0 15px 40px rgba(141, 110, 99, 0.15);
                    text-align: center;
                    transform: translateY(20px);
                    transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
                    font-family: 'Noto Serif TC', serif;
                }
                .sansi-limit-show .sansi-limit-card { transform: translateY(0); }
                .sansi-limit-icon { font-size: 3rem; color: #d69a92; margin-bottom: 15px; }
                .sansi-limit-title { color: #5d4037; font-size: 1.4rem; font-weight: bold; margin: 0 0 10px 0; }
                .sansi-limit-desc { color: #888; font-size: 1rem; line-height: 1.6; margin-bottom: 25px; text-align: justify; }
                .sansi-btn-group { display: flex; gap: 12px; margin-top: 20px; }
                .sansi-limit-btn {
                    border: none; padding: 10px 0; border-radius: 50px;
                    font-size: 0.95rem; font-weight: bold; cursor: pointer;
                    transition: all 0.2s; font-family: 'Noto Serif TC', serif;
                    flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;
                    text-decoration: none;
                }
                .btn-primary { background: #8fa398; color: white; box-shadow: 0 4px 12px rgba(143, 163, 152, 0.4); }
                .btn-primary:hover { background-color: #7d9186; transform: translateY(-2px); }
                .btn-secondary { background: #f0f0f0; color: #777; }
                .btn-secondary:hover { background-color: #e5e5e5; }
            `;
            document.head.appendChild(style);

            const modalHTML = `
                <div id="sansiLimitModal" class="sansi-limit-overlay">
                    <div class="sansi-limit-card">
                        <div class="sansi-limit-icon"><i class="fas fa-user-lock"></i></div>
                        <div class="sansi-limit-title">需要登入</div>
                        <div class="sansi-limit-desc">訪客每日體驗額度已耗盡。<br>請前往「神思」主頁登入學校帳號，即可解鎖無限使用權限。</div>
                        <div class="sansi-btn-group">
                            <button class="sansi-limit-btn btn-secondary" onclick="closeSansiLimitModal()">稍後</button>
                            <button class="sansi-limit-btn btn-primary" onclick="window.location.href='https://kenchan20141.github.io/AIChinese/'"><i class="fas fa-sign-in-alt"></i> 前往登入</button>
                        </div>
                    </div>
                </div>
            `;
            const div = document.createElement('div');
            div.innerHTML = modalHTML;
            document.body.appendChild(div);

            window.closeSansiLimitModal = function() {
                const modal = document.getElementById('sansiLimitModal');
                if (modal) {
                    modal.classList.remove('sansi-limit-show');
                    setTimeout(() => { modal.style.display = 'none'; }, 300);
                    if (typeof hideLoading === 'function') hideLoading();
                    const disabledBtns = document.querySelectorAll('button:disabled');
                    disabledBtns.forEach(btn => btn.disabled = false);
                }
            };

            const originalFetch = window.fetch;
            window.fetch = async function(url, options) {
                if (typeof url === 'string' && url.includes('pollinations.ai')) {
                    const s = localStorage.getItem('studentProfile');
                    if (s) return originalFetch(url, options);

                    const today = new Date().toLocaleDateString('zh-HK');
                    const toolName = document.title || "UnknownTool"; 
                    const storageKey = `sansi_guest_usage_${toolName}_${today}`;
                    let currentCount = parseInt(localStorage.getItem(storageKey) || "0");

                    if (currentCount >= 1) {
                        const modal = document.getElementById('sansiLimitModal');
                        modal.style.display = 'flex';
                        void modal.offsetWidth; 
                        modal.classList.add('sansi-limit-show');
                        return Promise.reject(new Error("Guest Limit Exceeded"));
                    }
                    localStorage.setItem(storageKey, currentCount + 1);
                }
                return originalFetch(url, options);
            };
        })();

        // 前端互動與 API 串接邏輯
        document.addEventListener('DOMContentLoaded', () => {
            const topicInput = document.getElementById('topic-input');
            const guidelinesInput = document.getElementById('guidelines-input');
            const decreaseBtn = document.getElementById('decrease-words');
            const increaseBtn = document.getElementById('increase-words');
            const wordCountDisplay = document.getElementById('word-count-display');
            const generateBtn = document.getElementById('generate-btn');
            const essayPlaceholder = document.getElementById('essay-placeholder');
            const generatedEssay = document.getElementById('generated-essay');
            const loader = document.getElementById('loader');
            const outputToolbar = document.getElementById('output-toolbar');
            const outputWordCount = document.getElementById('output-word-count');
            const copyBtn = document.getElementById('copy-btn');
            
            // GAS 後端網址
            const CLOUDFLARE_WORKER_URL = "https://script.google.com/macros/s/AKfycbzaAnSXaaCohL8b92B7bRzhMk3cMr7hhoQc1icKSr_Oy1JLFUPV32jbouJIKfEIgUepeA/exec";

            const originalCopyIcon = `<svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 0 24 24" width="20px"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-5zm0 16H8V7h11v14z"/></svg>`;
            copyBtn.innerHTML = originalCopyIcon;

            // 預設字數調整為 1000
            let wordCount = 1000;

            const updateWordCountDisplay = () => {
                wordCountDisplay.textContent = wordCount;
            };

            decreaseBtn.addEventListener('click', () => {
                if (wordCount > 100) {
                    wordCount -= 100;
                    updateWordCountDisplay();
                }
            });

            increaseBtn.addEventListener('click', () => {
                wordCount += 100;
                updateWordCountDisplay();
            });
            
            copyBtn.addEventListener('click', () => {
                if (!generatedEssay.textContent) return;
                
                navigator.clipboard.writeText(generatedEssay.textContent).then(() => {
                    copyBtn.innerHTML = `<span class="copy-feedback">已複製！</span>`;
                    setTimeout(() => {
                        copyBtn.innerHTML = originalCopyIcon;
                    }, 2000);
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗，您的瀏覽器可能不支援此功能。');
                });
            });

           generateBtn.addEventListener('click', async () => {
                const topic = topicInput.value.trim();
                const userGuidelines = guidelinesInput.value.trim();
                const selectedModel = document.querySelector('input[name="model"]:checked').value;
                
                // ★★★ 修改：隱藏指令也改為 Level 3 導向 ★★★
                const hiddenInstruction = "文章結構要清晰，論點要分段。請使用簡單易懂的例子，例如愛迪生、運動員或日常生活例子，不需要太深奧的歷史典故。";

                const finalGuidelines = userGuidelines 
                    ? `${userGuidelines}\n${hiddenInstruction}` 
                    : hiddenInstruction;
                
                if (!topic) {
                    alert('請輸入文章題目。');
                    return;
                }

                generateBtn.disabled = true;
                generateBtn.textContent = '生成基礎範文中...';
                loader.style.display = 'block';
                essayPlaceholder.style.display = 'none';
                generatedEssay.style.display = 'none';
                outputToolbar.style.display = 'none';
                
                try {
                    let systemPrompt = document.getElementById('argumentative-prompt').textContent;
                    systemPrompt = systemPrompt.replace(/\[請在此處填入您希望探討的議論文主題，例如.+\]/, `主題： ${topic}`);
                    // 此處放寬字數限制指令，讓 AI 自由發揮在 1000 字左右
                    systemPrompt = systemPrompt.replace(/約1000 - 1200字/g, `約${wordCount}字`);

                    if (finalGuidelines) {
                        systemPrompt += `\n\n[額外創作指引]\n${finalGuidelines}`;
                    }

                    const response = await fetch(CLOUDFLARE_WORKER_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: `題目：《${topic}》。請寫一篇適合Level 3-4學生閱讀的範文。` }
                            ],
                            stream: false
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API 請求失敗，狀態碼：${response.status}`);
                    }

                    const data = await response.json();

                    if (data._provider_log) {
                        console.log(`%c[Backend] Provider: ${data._provider_log}`, 'background: #2b2d42; color: #8d99ae; padding: 4px 8px;');
                    }
                    
                    if (data.error) {
                        throw new Error(`Backend Error: ${data.error}`);
                    }

                    const resultText = data.choices[0].message.content;

                    generatedEssay.textContent = resultText;
                    outputWordCount.textContent = `字數：${resultText.length}`;
                    generatedEssay.style.display = 'block';
                    outputToolbar.style.display = 'flex';

                } catch (error) {
                    console.error('生成失敗:', error);
                    essayPlaceholder.textContent = '生成失敗，請稍後再試。';
                    essayPlaceholder.style.display = 'flex';
                } finally {
                    generateBtn.disabled = false;
                    generateBtn.textContent = '生成基礎範文';
                    loader.style.display = 'none';
                }
            });

            updateWordCountDisplay();
        });
    </script>

    <!-- Firebase SDK & 相關邏輯保留原樣 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyBgwrgn2m343mRJb0WjzUhteiospegXhvI",
        authDomain: "sansidata.firebaseapp.com",
        projectId: "sansidata",
        storageBucket: "sansidata.firebasestorage.app",
        messagingSenderId: "580288358575",
        appId: "1:580288358575:web:35dcf4e79bcef530de4c5a",
        databaseURL: "https://sansidata-default-rtdb.firebaseio.com"
    };

    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    var database = firebase.database();
    var auth = firebase.auth();

    document.addEventListener('DOMContentLoaded', function() {
        if (auth) {
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                auth.onAuthStateChanged(async (user) => {
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    if (user && !s) {
                        try {
                            const emailKey = btoa(user.email);
                            const snapshot = await database.ref('email_mapping/' + emailKey).once('value');
                            const profile = snapshot.val();
                            if (profile) localStorage.setItem('studentProfile', JSON.stringify(profile));
                        } catch (e) { console.error("同步失敗:", e); }
                    }
                });
            });
        }
    });

    (function() {
        const originalFetch = window.fetch; 
        const TARGET_URL_PART = "script.google.com";

        window.fetch = async function(url, options) {
            if (typeof url === 'string' && url.includes(TARGET_URL_PART) && options && options.method === 'POST') {
                const user = await new Promise((resolve) => {
                    if (firebase.auth().currentUser) resolve(firebase.auth().currentUser);
                    else {
                        const unsubscribe = firebase.auth().onAuthStateChanged(u => {
                            unsubscribe();
                            resolve(u);
                        });
                        setTimeout(() => resolve(null), 2000);
                    }
                });

                if (user) {
                    try {
                        const token = await user.getIdToken(true);
                        let bodyData = {};
                        try { bodyData = JSON.parse(options.body); } catch(e) { bodyData = { originalBody: options.body }; }
                        bodyData.token = token;
                        options.body = JSON.stringify(bodyData);
                    } catch (e) { console.error("Token Error:", e); }
                }
            }
            return originalFetch(url, options);
        };
    })();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let totalSeconds = 0;
        let timerInterval = null;

        function getDateParts() {
            const now = new Date();
            return { 
                y: String(now.getFullYear()), 
                m: String(now.getMonth() + 1).padStart(2, '0'), 
                d: String(now.getDate()).padStart(2, '0') 
            };
        }

        function getIdentity() {
            const rawProfile = localStorage.getItem('studentProfile');
            let s = null;
            try { if(rawProfile) s = JSON.parse(rawProfile); } catch (e) {}

            if (s && s.grade && s.class) {
                const safeName = s.name.replace(/[.#$/[\]]/g, '_'); 
                return { type: 'student', id: s.uid || `stu_${s.grade}${s.class}_${safeName}`, grade: s.grade, class: s.class };
            } else {
                let guestID = localStorage.getItem('sansi_guest_uuid');
                if (!guestID) {
                    guestID = 'guest_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('sansi_guest_uuid', guestID);
                }
                return { type: 'guest', id: guestID, grade: 'Guest', class: 'Visitor' };
            }
        }

        async function logVisitOnce() {
            if (typeof firebase === 'undefined' || !database) return;
            const { y, m, d } = getDateParts();
            const identity = getIdentity();
            const uid = identity.id;
            const sessionKey = `sansi_visit_logged_${y}${m}${d}_${uid}`;
            if (sessionStorage.getItem(sessionKey)) return; 

            const trackingRef = database.ref(`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`);
            
            try {
                const snap = await trackingRef.once('value');
                const isFirstTimeToday = !snap.exists();
                const updates = {};
                const increment1 = firebase.database.ServerValue.increment(1);
                const globalPath = `stats_global/${y}/${m}/${d}`;
                updates[`${globalPath}/visits`] = increment1;
                const schoolPath = `stats_school/${y}/${m}/${d}`;

                if (identity.type === 'student') {
                    const classKey = `${identity.grade}${identity.class}`;
                    const studentKey = identity.id.split('_').pop();
                    updates[`${schoolPath}/visits`] = increment1;
                    const classPath = `stats_classes/${classKey}/${y}/${m}/${d}`;
                    updates[`${classPath}/visits`] = increment1;
                    const studentPath = `stats_students/${classKey}/${studentKey}/${y}/${m}/${d}`;
                    updates[`${studentPath}/visits`] = increment1;

                    if (isFirstTimeToday) {
                        updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                        updates[`${globalPath}/unique`] = increment1;
                        updates[`${schoolPath}/unique`] = increment1;
                        updates[`${classPath}/unique`] = increment1;
                    }
                } else {
                    if (isFirstTimeToday) {
                        updates[`stats_tracking/${y}/${m}/${d}/unique_users/${uid}`] = true;
                        updates[`${globalPath}/unique`] = increment1;
                    }
                }
                await database.ref().update(updates);
                sessionStorage.setItem(sessionKey, 'true');
            } catch (e) { console.error("Stats Error:", e); }
        }

        function uploadOneMinute() {
            if (typeof firebase === 'undefined' || !database) return;
            logVisitOnce(); 
            const { y, m, d } = getDateParts();
            const identity = getIdentity();
            const studentKey = identity.id.includes('_') ? identity.id.split('_').pop() : identity.name; 
            const updates = {};
            const increment60 = firebase.database.ServerValue.increment(60);
            updates[`stats_global/${y}/${m}/${d}/duration`] = increment60;

            if (identity.type === 'student') {
                const classKey = `${identity.grade}${identity.class}`;
                updates[`stats_school/${y}/${m}/${d}/duration`] = increment60;
                updates[`stats_classes/${classKey}/${y}/${m}/${d}/duration`] = increment60;
                updates[`stats_students/${classKey}/${studentKey}/${y}/${m}/${d}/duration`] = increment60;
            }

            database.ref().update(updates).catch(e => console.error(e));
        }

        function startTimer() {
            if (timerInterval) return;
            timerInterval = setInterval(() => {
                totalSeconds++;
                if (totalSeconds === 30 || (totalSeconds > 30 && (totalSeconds - 30) % 60 === 0)) {
                    uploadOneMinute();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        setTimeout(() => { logVisitOnce(); startTimer(); }, 3000);
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') pauseTimer();
            else startTimer();
        });
    });

    function initPresenceSystem() {
        setTimeout(() => {
            if (typeof database === 'undefined') return;
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    const s = JSON.parse(localStorage.getItem('studentProfile'));
                    let myUid = "";
                    let userData = {};
                    if (s && s.name) {
                        const user = firebase.auth().currentUser;
                        myUid = user ? user.uid : `stu_${s.grade}${s.class}_${s.name}`;
                        userData = {
                            name: s.name, grade: s.grade, class: s.class,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            device: /Mobile|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop'
                        };
                    } else {
                        let guestId = localStorage.getItem('sansi_guest_uuid');
                        if (!guestId) {
                            guestId = 'guest_' + Math.random().toString(36).substr(2, 9);
                            localStorage.setItem('sansi_guest_uuid', guestId);
                        }
                        myUid = guestId;
                        userData = { name: "訪客", grade: "Guest", class: "Visitor", timestamp: firebase.database.ServerValue.TIMESTAMP };
                    }
                    const myPresenceRef = database.ref(`online_users/${myUid}`);
                    myPresenceRef.onDisconnect().remove().then(() => {
                        myPresenceRef.set(userData);
                    });
                }
            });
        }, 2000);
    }
    document.addEventListener('DOMContentLoaded', initPresenceSystem);
    </script>
</body>
</html>
